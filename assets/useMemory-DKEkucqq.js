var w=Object.defineProperty;var x=(c,u,e)=>u in c?w(c,u,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[u]=e;var H=(c,u,e)=>x(c,typeof u!="symbol"?u+"":u,e);import{E as A,C as W,M as $,T as k,D as S,k as N,m as h,n as j,p as C,c as F}from"./GameInfo-Bh6km_Gm.js";import{x as D}from"./index-Dw82Q0pD.js";import{r as O,aJ as T,w as J}from"./vue-DmXGC6sY.js";const _={DecomposeCalculator:S,TransmuteCalculator:k,ManufactureCalculator:$,CoinifyCalculator:W,EnhanceCalculator:A};function Q(c){return!!_[c]}function y(c){const u=c.className,e=_[u];return new e(c)}function U(c){return{className:c.className,id:c.id,...c.config}}class X extends N{constructor(e,s){let t=e[e.length-1];Array.isArray(t)&&(t=t[0]);super({hrid:t.hrid,project:s,action:t.action});H(this,"calculatorList",[]);H(this,"configs",[]);H(this,"_ingredientPreprocess");H(this,"_productPreprocess");H(this,"_workMultiplier");H(this,"_resultList");this.configs=e;for(let i=e.length-1;i>=0;i--){const r=e[i];if(Array.isArray(r)){if(i!==e.length-1)throw new Error("Workflow只支持最后一个阶段为数组");const g=e[i-1];g.productPriceConfigList=r.map(p=>({immutable:!0,price:0,hrid:p.hrid}));const m=[];r.forEach(p=>{p.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:g.hrid}];const d=y(p);d.available&&d.run(),d.hasManualPrice&&(this.hasManualPrice=!0),m.push(d)}),this.calculatorList.push(m);continue}i>0&&(r.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:r.hrid}]),i<e.length-1&&!r.productPriceConfigList&&(r.productPriceConfigList=[{immutable:!0,price:0,hrid:r.hrid}]);let a=y(r),n=!1;if(a.available&&i>0){const g=a.ingredientList[0];for(const m in a.ingredientList){const p=a.ingredientList[m];p.hrid===g.hrid&&(p.level||0)===(g.level||0)&&(r.ingredientPriceConfigList[m]={immutable:!0,price:0,hrid:r.hrid},n=!0)}n&&(a=y(r))}a.available&&a.run(),a.hasManualPrice&&(this.hasManualPrice=!0),this.calculatorList.push(a)}this.calculatorList.reverse()}get ingredientList(){return[]}get productList(){return[]}get className(){return"WorkflowCalculator"}get catalyst(){return this.calculatorList[this.calculatorList.length-1].catalyst}get ingredientListPreprocess(){if(!this._ingredientPreprocess){const e=this.calculatorList.flat().map(i=>i.ingredientListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._ingredientPreprocess={list:s,map:t}}return this._ingredientPreprocess}get productListWithPricePreprocess(){if(!this._productPreprocess){const e=this.calculatorList.flat().map(i=>i.productListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._productPreprocess={list:s,map:t}}return this._productPreprocess}get sameItemCounterMap(){const{map:e}=this.ingredientListPreprocess,{map:s}=this.productListWithPricePreprocess,t=new Map;return s.forEach((i,r)=>{e.has(r)&&t.set(r,Math.min(e.get(r),i))}),t}get ingredientListWithPrice(){const{list:e}=this.ingredientListPreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}get productListWithPrice(){const{list:e}=this.productListWithPricePreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}mergeIngredient(e){const s=new Map;return e.forEach(t=>{const i=`${t.hrid}-${t.level||0}`;if(s.has(i)){const r=s.get(i);r.count+=t.count,r.countPH+=t.countPH}else s.set(i,{...t})}),Array.from(s.values())}get available(){return this.calculatorList.flat().every(e=>e.available)}get actionLevel(){return Math.max(...this.calculatorList.flat().map(e=>e.actionLevel))}get timeCost(){return this.calculatorList.flat()[0].timeCost/this.workMultiplier.flat()[0]}get calculator(){return this.calculatorList.flat()[this.calculatorList.flat().length-1]}get expList(){const e=new Map;return this.resultList.flat().forEach(s=>{e.set(s.action,e.get(s.project)||0+s.expPH)}),Array.from(e.entries()).map(([s,t])=>({action:s,expPH:t,expPHFormat:h(t)}))}get workMultiplier(){if(this._workMultiplier)return this._workMultiplier;const e=[1],s=this.calculatorList.map(r=>Array.isArray(r)?r.map(a=>a.result):r.result);for(let r=0;r<this.calculatorList.length;r++){const a=this.calculatorList[r],n=this.calculatorList[r+1];if(!n)break;if(Array.isArray(n)){const f=[];for(let P=0;P<n.length;++P){const o=n[P].ingredientList,I=a.productList.find(L=>L.hrid===o[0].hrid&&(L.level||0)===(o[0].level||0)),E=I.count*(I.rate||1)*s[r].gainPH,R=o.filter(L=>L.hrid===o[0].hrid&&(L.level||0)===(o[0].level||0)).reduce((L,b)=>L+b.count,0)*s[r+1][P].consumePH;f.push(E/R)}e.push(f);continue}const g=a.hrid,m=a.productList.find(f=>f.hrid===g),p=m.count*(m.rate||1)*s[r].gainPH,v=n.ingredientList.filter(f=>f.hrid===g).reduce((f,P)=>f+P.count,0)*s[r+1].consumePH;e.push(p/v)}const t=[];for(let r=0;r<e.length;r++){const a=e[r];t[r]=Array.isArray(a)?a.map(n=>n*(t[r-1]||1)):a*(t[r-1]||1)}const i=t.flat().reduce((r,a)=>r+a,0);return this._workMultiplier=t.map(r=>Array.isArray(r)?r.map(a=>a/i):r/i),this._workMultiplier}run(){const e=this.calculator.item,s=this.resultList.flat().reduce((l,o)=>l+o.costPH,0),t=this.resultList.flat().reduce((l,o)=>l+o.incomePH,0);let i=this.resultList.flat().reduce((l,o)=>l+o.profitPH,0);const r=i/s;this.calculatorList.flat().some(l=>!l.valid)&&(i=-1/24);const a=this.resultList.flat().reduce((l,o)=>l+(o.expPH||0),0);let n=this.calculatorList[this.calculatorList.length-1],g=this.resultList[this.resultList.length-1];Array.isArray(n)&&(n=this.calculatorList[this.calculatorList.length-2],g=this.resultList[this.resultList.length-2]);const m=n.actionsPH*g.workMultiplier;let p=i/m;n instanceof A&&(p*=n.enhancelate().actions);const d=this.calculatorList[this.calculatorList.length-1],M=this.resultList[this.resultList.length-1],f=[d].flat()[0].escapeLevel!==-1?s-[M].flat().reduce((l,o)=>l+o.gainEscapePH,0):[M].flat().reduce((l,o)=>l+o.cost4MatPH,0),P=f/i;return this.result={workMultiplier:this.workMultiplier,hrid:e.hrid,name:D(e.name),project:this.project,successRate:1,costPH:s,consumePH:-1,gainPH:-1,incomePH:t,profitPH:i,profitRate:r,costPHFormat:h(s),incomePHFormat:h(t),profitPHFormat:h(i),profitPDFormat:h(i*24),profitPPFormat:h(p),profitRateFormat:C(r),efficiencyFormat:C(0),timeCostFormat:F(this.timeCost),successRateFormat:C(1),expPHFormat:h(a),cost4EnhancePHFormat:h(f),risk:P,riskFormat:j(P,2)},this}constructResult(e,s){const t=e.result;return{action:e.action,workMultiplier:s,hrid:e.item.hrid,name:e.item.name,project:e.project,successRate:e.successRate,costPH:t.costPH*s,consumePH:t.consumePH*s,gainPH:t.gainPH*s,incomePH:t.incomePH*s,profitPH:t.profitPH*s,expPH:t.expPH*s,profitRate:t.profitRate,gainEscapePH:e.gainEscapePH*s,cost4MatPH:t.cost4MatPH*s,costPHFormat:h(t.costPH*s),incomePHFormat:h(t.incomePH*s),profitPHFormat:h(t.profitPH*s),profitPDFormat:h(t.profitPH*24*s),profitRateFormat:C(t.profitRate),efficiencyFormat:C(e.efficiency-1),timeCostFormat:F(e.timeCost),successRateFormat:C(t.successRate),expPHFormat:h(t.expPH*s)}}get resultList(){return this._resultList?this._resultList:(this._resultList=this.calculatorList.map((e,s)=>{if(!Array.isArray(e))return this.constructResult(e,this.workMultiplier[s]);const t=this.workMultiplier[s];return e.map((i,r)=>this.constructResult(i,t[r]))}),this._resultList)}}function Y(c,u,e=500){const t=O((()=>{try{const r=localStorage.getItem(c);return r?JSON.parse(r):u}catch{return u}})()),i=T(r=>{try{localStorage.setItem(c,JSON.stringify(r))}catch(a){console.error("LocalStorage 保存失败:",a)}},e);return J(t,i,{deep:!0}),t}export{X as W,y as a,Q as c,U as g,Y as u};
