var w=Object.defineProperty;var x=(o,u,e)=>u in o?w(o,u,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[u]=e;var C=(o,u,e)=>x(o,typeof u!="symbol"?u+"":u,e);import{E as A,C as S,M as W,T as $,D as k,k as N,m as h,n as j,p as M,c as F}from"./GameInfo-BwB3C6uv.js";import{x as D}from"./index-IzvUu-VJ.js";import{r as T,aJ as O,w as J}from"./vue-0ucuI9Mt.js";const _={DecomposeCalculator:k,TransmuteCalculator:$,ManufactureCalculator:W,CoinifyCalculator:S,EnhanceCalculator:A};function Q(o){return!!_[o]}function y(o){const u=o.className,e=_[u];return new e(o)}function U(o){return{className:o.className,id:o.id,...o.config}}class X extends N{constructor(e,s,t=.98){let i=e[e.length-1];Array.isArray(i)&&(i=i[0]);super({hrid:i.hrid,project:s,action:i.action});C(this,"calculatorList",[]);C(this,"configs",[]);C(this,"_ingredientPreprocess");C(this,"_productPreprocess");C(this,"_workMultiplier");C(this,"_resultList");this.setSellTaxFactor(t),this.configs=e;for(let r=e.length-1;r>=0;r--){const a=e[r];if(Array.isArray(a)){if(r!==e.length-1)throw new Error("Workflow只支持最后一个阶段为数组");const g=e[r-1];g.productPriceConfigList=a.map(m=>({immutable:!0,price:0,hrid:m.hrid}));const f=[];a.forEach(m=>{m.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:g.hrid}];const P=y(m);P.setSellTaxFactor(t),P.available&&P.run(),P.hasManualPrice&&(this.hasManualPrice=!0),f.push(P)}),this.calculatorList.push(f);continue}r>0&&(a.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:a.hrid}]),r<e.length-1&&!a.productPriceConfigList&&(a.productPriceConfigList=[{immutable:!0,price:0,hrid:a.hrid}]);let c=y(a);c.setSellTaxFactor(t);let L=!1;if(c.available&&r>0){const g=c.ingredientList[0];for(const f in c.ingredientList){const m=c.ingredientList[f];m.hrid===g.hrid&&(m.level||0)===(g.level||0)&&(a.ingredientPriceConfigList[f]={immutable:!0,price:0,hrid:a.hrid},L=!0)}L&&(c=y(a),c.setSellTaxFactor(t))}c.available&&c.run(),c.hasManualPrice&&(this.hasManualPrice=!0),this.calculatorList.push(c)}this.calculatorList.reverse()}get ingredientList(){return[]}get productList(){return[]}get className(){return"WorkflowCalculator"}get catalyst(){return this.calculatorList[this.calculatorList.length-1].catalyst}get ingredientListPreprocess(){if(!this._ingredientPreprocess){const e=this.calculatorList.flat().map(i=>i.ingredientListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._ingredientPreprocess={list:s,map:t}}return this._ingredientPreprocess}get productListWithPricePreprocess(){if(!this._productPreprocess){const e=this.calculatorList.flat().map(i=>i.productListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._productPreprocess={list:s,map:t}}return this._productPreprocess}get sameItemCounterMap(){const{map:e}=this.ingredientListPreprocess,{map:s}=this.productListWithPricePreprocess,t=new Map;return s.forEach((i,r)=>{e.has(r)&&t.set(r,Math.min(e.get(r),i))}),t}get ingredientListWithPrice(){const{list:e}=this.ingredientListPreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}get productListWithPrice(){const{list:e}=this.productListWithPricePreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}mergeIngredient(e){const s=new Map;return e.forEach(t=>{const i=`${t.hrid}-${t.level||0}`;if(s.has(i)){const r=s.get(i);r.count+=t.count,r.countPH+=t.countPH}else s.set(i,{...t})}),Array.from(s.values())}get available(){return this.calculatorList.flat().every(e=>e.available)}get actionLevel(){return Math.max(...this.calculatorList.flat().map(e=>e.actionLevel))}get timeCost(){return this.calculatorList.flat()[0].timeCost/this.workMultiplier.flat()[0]}get calculator(){return this.calculatorList.flat()[this.calculatorList.flat().length-1]}get expList(){const e=new Map;return this.resultList.flat().forEach(s=>{e.set(s.action,e.get(s.project)||0+s.expPH)}),Array.from(e.entries()).map(([s,t])=>({action:s,expPH:t,expPHFormat:h(t)}))}get workMultiplier(){if(this._workMultiplier)return this._workMultiplier;const e=[1],s=this.calculatorList.map(r=>Array.isArray(r)?r.map(a=>a.result):r.result);for(let r=0;r<this.calculatorList.length;r++){const a=this.calculatorList[r],c=this.calculatorList[r+1];if(!c)break;if(Array.isArray(c)){const p=[];for(let d=0;d<c.length;++d){const n=c[d].ingredientList,I=a.productList.find(H=>H.hrid===n[0].hrid&&(H.level||0)===(n[0].level||0)),E=I.count*(I.rate||1)*s[r].gainPH,R=n.filter(H=>H.hrid===n[0].hrid&&(H.level||0)===(n[0].level||0)).reduce((H,b)=>H+b.count,0)*s[r+1][d].consumePH;p.push(E/R)}e.push(p);continue}const L=a.hrid,g=a.productList.find(p=>p.hrid===L),f=g.count*(g.rate||1)*s[r].gainPH,v=c.ingredientList.filter(p=>p.hrid===L).reduce((p,d)=>p+d.count,0)*s[r+1].consumePH;e.push(f/v)}const t=[];for(let r=0;r<e.length;r++){const a=e[r];t[r]=Array.isArray(a)?a.map(c=>c*(t[r-1]||1)):a*(t[r-1]||1)}const i=t.flat().reduce((r,a)=>r+a,0);return this._workMultiplier=t.map(r=>Array.isArray(r)?r.map(a=>a/i):r/i),this._workMultiplier}run(){const e=this.calculator.item,s=this.resultList.flat().reduce((l,n)=>l+n.costPH,0),t=this.resultList.flat().reduce((l,n)=>l+n.incomePH,0);let i=this.resultList.flat().reduce((l,n)=>l+n.profitPH,0);const r=i/s;this.calculatorList.flat().some(l=>!l.valid)&&(i=-1/24);const a=this.resultList.flat().reduce((l,n)=>l+(n.expPH||0),0);let c=this.calculatorList[this.calculatorList.length-1],L=this.resultList[this.resultList.length-1];Array.isArray(c)&&(c=this.calculatorList[this.calculatorList.length-2],L=this.resultList[this.resultList.length-2]);const g=c.actionsPH*L.workMultiplier;let f=i/g;c instanceof A&&(f*=c.enhancelate().actions);const m=this.calculatorList[this.calculatorList.length-1],P=this.resultList[this.resultList.length-1],p=[m].flat()[0].escapeLevel!==-1?s-[P].flat().reduce((l,n)=>l+n.gainEscapePH,0):[P].flat().reduce((l,n)=>l+n.cost4MatPH,0),d=p/i;return this.result={workMultiplier:this.workMultiplier,hrid:e.hrid,name:D(e.name),project:this.project,successRate:1,costPH:s,consumePH:-1,gainPH:-1,incomePH:t,profitPH:i,profitRate:r,costPHFormat:h(s),incomePHFormat:h(t),profitPHFormat:h(i),profitPDFormat:h(i*24),profitPPFormat:h(f),profitRateFormat:M(r),efficiencyFormat:M(0),timeCostFormat:F(this.timeCost),successRateFormat:M(1),expPHFormat:h(a),cost4EnhancePHFormat:h(p),risk:d,riskFormat:j(d,2)},this}constructResult(e,s){const t=e.result;return{action:e.action,workMultiplier:s,hrid:e.item.hrid,name:e.item.name,project:e.project,successRate:e.successRate,costPH:t.costPH*s,consumePH:t.consumePH*s,gainPH:t.gainPH*s,incomePH:t.incomePH*s,profitPH:t.profitPH*s,expPH:t.expPH*s,profitRate:t.profitRate,gainEscapePH:e.gainEscapePH*s,cost4MatPH:t.cost4MatPH*s,costPHFormat:h(t.costPH*s),incomePHFormat:h(t.incomePH*s),profitPHFormat:h(t.profitPH*s),profitPDFormat:h(t.profitPH*24*s),profitRateFormat:M(t.profitRate),efficiencyFormat:M(e.efficiency-1),timeCostFormat:F(e.timeCost),successRateFormat:M(t.successRate),expPHFormat:h(t.expPH*s)}}get resultList(){return this._resultList?this._resultList:(this._resultList=this.calculatorList.map((e,s)=>{if(!Array.isArray(e))return this.constructResult(e,this.workMultiplier[s]);const t=this.workMultiplier[s];return e.map((i,r)=>this.constructResult(i,t[r]))}),this._resultList)}}function Y(o,u,e=500){const t=T((()=>{try{const r=localStorage.getItem(o);return r?JSON.parse(r):u}catch{return u}})()),i=O(r=>{try{localStorage.setItem(o,JSON.stringify(r))}catch(a){console.error("LocalStorage 保存失败:",a)}},e);return J(t,i,{deep:!0}),t}export{X as W,y as a,Q as c,U as g,Y as u};
