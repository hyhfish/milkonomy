var b=Object.defineProperty;var w=(o,f,e)=>f in o?b(o,f,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[f]=e;var H=(o,f,e)=>w(o,typeof f!="symbol"?f+"":f,e);import{E as A,C as W,M as $,T as k,D as j,k as N,m as u,n as D,p as C,c as F}from"./GameInfo-D088-w9H.js";import{x as T}from"./index-JnRM8nM7.js";const _={DecomposeCalculator:j,TransmuteCalculator:k,ManufactureCalculator:$,CoinifyCalculator:W,EnhanceCalculator:A};function G(o){return!!_[o]}function y(o){const f=o.className,e=_[f];return new e(o)}function J(o){return{className:o.className,id:o.id,...o.config}}class K extends N{constructor(e,s){let t=e[e.length-1];Array.isArray(t)&&(t=t[0]);super({hrid:t.hrid,project:s,action:t.action});H(this,"calculatorList",[]);H(this,"configs",[]);H(this,"_ingredientPreprocess");H(this,"_productPreprocess");H(this,"_workMultiplier");H(this,"_resultList");this.configs=e;for(let i=e.length-1;i>=0;i--){const r=e[i];if(Array.isArray(r)){if(i!==e.length-1)throw new Error("Workflow只支持最后一个阶段为数组");const p=e[i-1];p.productPriceConfigList=r.map(h=>({immutable:!0,price:0,hrid:h.hrid}));const P=[];r.forEach(h=>{h.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:p.hrid}];const d=y(h);d.available&&d.run(),d.hasManualPrice&&(this.hasManualPrice=!0),P.push(d)}),this.calculatorList.push(P);continue}i>0&&(r.ingredientPriceConfigList=[{immutable:!0,price:0,hrid:r.hrid}]),i<e.length-1&&!r.productPriceConfigList&&(r.productPriceConfigList=[{immutable:!0,price:0,hrid:r.hrid}]);let a=y(r),n=!1;if(a.available&&i>0){const p=a.ingredientList[0];for(const P in a.ingredientList){const h=a.ingredientList[P];h.hrid===p.hrid&&(h.level||0)===(p.level||0)&&(r.ingredientPriceConfigList[P]={immutable:!0,price:0,hrid:r.hrid},n=!0)}n&&(a=y(r))}a.available&&a.run(),a.hasManualPrice&&(this.hasManualPrice=!0),this.calculatorList.push(a)}this.calculatorList.reverse()}get ingredientList(){return[]}get productList(){return[]}get className(){return"WorkflowCalculator"}get catalyst(){return this.calculatorList[this.calculatorList.length-1].catalyst}get ingredientListPreprocess(){if(!this._ingredientPreprocess){const e=this.calculatorList.flat().map(i=>i.ingredientListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._ingredientPreprocess={list:s,map:t}}return this._ingredientPreprocess}get productListWithPricePreprocess(){if(!this._productPreprocess){const e=this.calculatorList.flat().map(i=>i.productListWithPrice).flatMap((i,r)=>i.map(a=>({...a,countPH:a.countPH*this.workMultiplier.flat()[r]}))),s=this.mergeIngredient(e),t=new Map;s.forEach(i=>t.set(`${i.hrid}-${i.level||0}`,i.countPH)),this._productPreprocess={list:s,map:t}}return this._productPreprocess}get sameItemCounterMap(){const{map:e}=this.ingredientListPreprocess,{map:s}=this.productListWithPricePreprocess,t=new Map;return s.forEach((i,r)=>{e.has(r)&&t.set(r,Math.min(e.get(r),i))}),t}get ingredientListWithPrice(){const{list:e}=this.ingredientListPreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}get productListWithPrice(){const{list:e}=this.productListWithPricePreprocess,s=this.sameItemCounterMap;return e.map(t=>({...t,countPH:t.countPH-(s.get(`${t.hrid}-${t.level||0}`)||0)})).filter(t=>t.countPH>1e-8)}mergeIngredient(e){const s=new Map;return e.forEach(t=>{const i=`${t.hrid}-${t.level||0}`;if(s.has(i)){const r=s.get(i);r.count+=t.count,r.countPH+=t.countPH}else s.set(i,{...t})}),Array.from(s.values())}get available(){return this.calculatorList.flat().every(e=>e.available)}get actionLevel(){return Math.max(...this.calculatorList.flat().map(e=>e.actionLevel))}get timeCost(){return this.calculatorList.flat()[0].timeCost/this.workMultiplier.flat()[0]}get calculator(){return this.calculatorList.flat()[this.calculatorList.flat().length-1]}get expList(){const e=new Map;return this.resultList.flat().forEach(s=>{e.set(s.action,e.get(s.project)||0+s.expPH)}),Array.from(e.entries()).map(([s,t])=>({action:s,expPH:t,expPHFormat:u(t)}))}get workMultiplier(){if(this._workMultiplier)return this._workMultiplier;const e=[1],s=this.calculatorList.map(r=>Array.isArray(r)?r.map(a=>a.result):r.result);for(let r=0;r<this.calculatorList.length;r++){const a=this.calculatorList[r],n=this.calculatorList[r+1];if(!n)break;if(Array.isArray(n)){const g=[];for(let m=0;m<n.length;++m){const c=n[m].ingredientList,I=a.productList.find(L=>L.hrid===c[0].hrid&&(L.level||0)===(c[0].level||0)),E=I.count*(I.rate||1)*s[r].gainPH,R=c.filter(L=>L.hrid===c[0].hrid&&(L.level||0)===(c[0].level||0)).reduce((L,x)=>L+x.count,0)*s[r+1][m].consumePH;g.push(E/R)}e.push(g);continue}const p=a.hrid,P=a.productList.find(g=>g.hrid===p),h=P.count*(P.rate||1)*s[r].gainPH,v=n.ingredientList.filter(g=>g.hrid===p).reduce((g,m)=>g+m.count,0)*s[r+1].consumePH;e.push(h/v)}const t=[];for(let r=0;r<e.length;r++){const a=e[r];t[r]=Array.isArray(a)?a.map(n=>n*(t[r-1]||1)):a*(t[r-1]||1)}const i=t.flat().reduce((r,a)=>r+a,0);return this._workMultiplier=t.map(r=>Array.isArray(r)?r.map(a=>a/i):r/i),this._workMultiplier}run(){const e=this.calculator.item,s=this.resultList.flat().reduce((l,c)=>l+c.costPH,0),t=this.resultList.flat().reduce((l,c)=>l+c.incomePH,0);let i=this.resultList.flat().reduce((l,c)=>l+c.profitPH,0);const r=i/s;this.calculatorList.flat().some(l=>!l.valid)&&(i=-1/24);const a=this.resultList.flat().reduce((l,c)=>l+(c.expPH||0),0);let n=this.calculatorList[this.calculatorList.length-1],p=this.resultList[this.resultList.length-1];Array.isArray(n)&&(n=this.calculatorList[this.calculatorList.length-2],p=this.resultList[this.resultList.length-2]);const P=n.actionsPH*p.workMultiplier;let h=i/P;n instanceof A&&(h*=n.enhancelate().actions);const d=this.calculatorList[this.calculatorList.length-1],M=this.resultList[this.resultList.length-1],g=[d].flat()[0].escapeLevel!==-1?s-[M].flat().reduce((l,c)=>l+c.gainEscapePH,0):[M].flat().reduce((l,c)=>l+c.cost4MatPH,0),m=g/i;return this.result={workMultiplier:this.workMultiplier,hrid:e.hrid,name:T(e.name),project:this.project,successRate:1,costPH:s,consumePH:-1,gainPH:-1,incomePH:t,profitPH:i,profitRate:r,costPHFormat:u(s),incomePHFormat:u(t),profitPHFormat:u(i),profitPDFormat:u(i*24),profitPPFormat:u(h),profitRateFormat:C(r),efficiencyFormat:C(0),timeCostFormat:F(this.timeCost),successRateFormat:C(1),expPHFormat:u(a),cost4EnhancePHFormat:u(g),risk:m,riskFormat:D(m,2)},this}constructResult(e,s){const t=e.result;return{action:e.action,workMultiplier:s,hrid:e.item.hrid,name:e.item.name,project:e.project,successRate:e.successRate,costPH:t.costPH*s,consumePH:t.consumePH*s,gainPH:t.gainPH*s,incomePH:t.incomePH*s,profitPH:t.profitPH*s,expPH:t.expPH*s,profitRate:t.profitRate,gainEscapePH:e.gainEscapePH*s,cost4MatPH:t.cost4MatPH*s,costPHFormat:u(t.costPH*s),incomePHFormat:u(t.incomePH*s),profitPHFormat:u(t.profitPH*s),profitPDFormat:u(t.profitPH*24*s),profitRateFormat:C(t.profitRate),efficiencyFormat:C(e.efficiency-1),timeCostFormat:F(e.timeCost),successRateFormat:C(t.successRate),expPHFormat:u(t.expPH*s)}}get resultList(){return this._resultList?this._resultList:(this._resultList=this.calculatorList.map((e,s)=>{if(!Array.isArray(e))return this.constructResult(e,this.workMultiplier[s]);const t=this.workMultiplier[s];return e.map((i,r)=>this.constructResult(i,t[r]))}),this._resultList)}}export{K as W,y as a,G as c,J as g};
